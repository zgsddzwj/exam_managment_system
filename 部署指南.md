# 阿里云部署指南

本指南将帮助您将考试管理系统部署到阿里云服务器上。

## 部署架构

```
Internet
    ↓
阿里云ECS服务器 (Ubuntu/CentOS)
    ├── Nginx (80/443端口) - 反向代理和静态文件服务
    ├── Django Backend (8000端口) - Gunicorn + Supervisor
    ├── PostgreSQL数据库 (5432端口) - 可选，或使用RDS
    └── Frontend静态文件 - 构建后的React应用
```

## 前置准备

### 1. 阿里云服务器要求

- **操作系统**: Ubuntu 20.04/22.04 或 CentOS 7/8
- **配置推荐**: 
  - 最低: 2核CPU, 4GB内存, 40GB存储
  - 推荐: 4核CPU, 8GB内存, 100GB存储
- **网络**: 公网IP，开放端口: 80, 443, 22

### 2. 域名（可选但推荐）

- 购买域名并完成备案（国内服务器）
- 配置DNS解析到服务器公网IP

## 部署步骤

### 第一步：服务器环境准备

#### 1.1 连接服务器

```bash
ssh root@your-server-ip
```

#### 1.2 更新系统

```bash
# Ubuntu
apt update && apt upgrade -y

# CentOS
yum update -y
```

#### 1.3 安装基础软件

```bash
# Ubuntu
apt install -y git curl wget vim nginx supervisor postgresql postgresql-contrib
apt install -y python3 python3-pip python3-venv
apt install -y nodejs npm

# CentOS
yum install -y git curl wget vim nginx supervisor postgresql-server postgresql-contrib
yum install -y python3 python3-pip nodejs npm
```

#### 1.4 安装Node.js（如果版本过低）

```bash
curl -fsSL https://deb.nodesource.com/setup_18.x | bash -  # Ubuntu
apt install -y nodejs

# 或使用nvm
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 18
nvm use 18
```

### 第二步：创建应用用户和目录

```bash
# 创建应用用户
useradd -m -s /bin/bash examuser

# 创建应用目录
mkdir -p /var/www/exam_management
chown examuser:examuser /var/www/exam_management

# 切换到应用用户
su - examuser
cd /var/www/exam_management
```

### 第三步：克隆代码并安装依赖

#### 3.1 克隆代码

```bash
git clone https://github.com/zgsddzwj/exam_managment_system.git .
# 或使用SSH: git clone git@github.com:zgsddzwj/exam_managment_system.git .
```

#### 3.2 配置后端环境

```bash
cd backend

# 创建Python虚拟环境
python3 -m venv venv
source venv/bin/activate

# 安装Python依赖
pip install --upgrade pip
pip install -r requirements.txt

# 安装Gunicorn（生产环境WSGI服务器）
pip install gunicorn

# 创建.env配置文件
cp .env.example .env  # 如果存在
# 或直接创建
nano .env
```

#### 3.3 配置后端.env文件

```env
# Django Settings
SECRET_KEY=your-secret-key-here-generate-a-new-one
DEBUG=False
ALLOWED_HOSTS=your-domain.com,www.your-domain.com,your-server-ip

# Database (PostgreSQL)
USE_POSTGRES=True
DB_NAME=exam_management
DB_USER=examuser
DB_PASSWORD=your-secure-password
DB_HOST=localhost
DB_PORT=5432

# Judge0 API
JUDGE0_API_URL=https://judge0-ce.p.rapidapi.com
JUDGE0_API_KEY=your-judge0-api-key
JUDGE0_RAPIDAPI_HOST=judge0-ce.p.rapidapi.com

# DeepSeek API
DEEPSEEK_API_KEY=your-deepseek-api-key
```

**生成SECRET_KEY:**

```bash
python -c 'from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())'
```

#### 3.4 配置数据库

```bash
# 切换回root用户配置PostgreSQL
exit
sudo -u postgres createuser --interactive examuser
# 输入y创建为超级用户，或根据需要设置权限

sudo -u postgres createdb exam_management
sudo -u postgres psql -c "ALTER USER examuser WITH PASSWORD 'your-secure-password';"
sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE exam_management TO examuser;"

# 回到应用用户
su - examuser
cd /var/www/exam_management/backend
source venv/bin/activate

# 运行数据库迁移
python manage.py migrate

# 收集静态文件
python manage.py collectstatic --noinput

# 创建超级用户（可选）
python manage.py createsuperuser
```

#### 3.5 构建前端

```bash
cd /var/www/exam_management/frontend

# 安装依赖
npm install

# 创建.env.production文件
echo "VITE_API_BASE_URL=https://your-domain.com/api" > .env.production
# 或使用IP: echo "VITE_API_BASE_URL=http://your-server-ip/api" > .env.production

# 构建生产版本
npm run build

# 构建后的文件在 dist/ 目录
```

### 第四步：配置Gunicorn

```bash
cd /var/www/exam_management/backend

# 创建Gunicorn配置文件
nano gunicorn_config.py
```

**gunicorn_config.py内容:**

```python
import multiprocessing

bind = "127.0.0.1:8000"
workers = multiprocessing.cpu_count() * 2 + 1
worker_class = "sync"
worker_connections = 1000
timeout = 120
keepalive = 5
max_requests = 1000
max_requests_jitter = 50
preload_app = True
daemon = False
pidfile = "/var/www/exam_management/backend/gunicorn.pid"
accesslog = "/var/www/exam_management/backend/logs/gunicorn_access.log"
errorlog = "/var/www/exam_management/backend/logs/gunicorn_error.log"
loglevel = "info"
```

创建日志目录:

```bash
mkdir -p /var/www/exam_management/backend/logs
```

### 第五步：配置Supervisor（进程管理）

```bash
# 切换到root用户
exit
sudo nano /etc/supervisor/conf.d/exam_management.conf
```

**supervisor配置文件内容:**

```ini
[program:exam_management]
command=/var/www/exam_management/backend/venv/bin/gunicorn config.wsgi:application -c /var/www/exam_management/backend/gunicorn_config.py
directory=/var/www/exam_management/backend
user=examuser
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/www/exam_management/backend/logs/supervisor.log
environment=PATH="/var/www/exam_management/backend/venv/bin"
```

启动Supervisor:

```bash
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start exam_management
sudo supervisorctl status
```

### 第六步：配置Nginx

```bash
sudo nano /etc/nginx/sites-available/exam_management
```

**Nginx配置文件内容:**

```nginx
# HTTP重定向到HTTPS（如果有SSL证书）
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;

    # 如果有SSL证书，取消注释以下部分
    # return 301 https://$server_name$request_uri;

    # 如果没有SSL证书，使用以下配置
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 前端静态文件
    location /static/ {
        alias /var/www/exam_management/backend/staticfiles/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    location /media/ {
        alias /var/www/exam_management/backend/media/;
        expires 30d;
    }

    # 前端应用
    location / {
        root /var/www/exam_management/frontend/dist;
        try_files $uri $uri/ /index.html;
    }

    # API代理
    location /api/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 增加超时时间（用于AI解析功能）
        proxy_connect_timeout 180s;
        proxy_send_timeout 180s;
        proxy_read_timeout 180s;
    }
}

# HTTPS配置（如果有SSL证书）
# server {
#     listen 443 ssl http2;
#     server_name your-domain.com www.your-domain.com;
# 
#     ssl_certificate /path/to/certificate.crt;
#     ssl_certificate_key /path/to/private.key;
# 
#     # SSL优化配置
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;
#     ssl_prefer_server_ciphers on;
# 
#     # 其他配置同上
#     location / {
#         root /var/www/exam_management/frontend/dist;
#         try_files $uri $uri/ /index.html;
#     }
# 
#     location /api/ {
#         proxy_pass http://127.0.0.1:8000;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_connect_timeout 180s;
#         proxy_send_timeout 180s;
#         proxy_read_timeout 180s;
#     }
# 
#     location /static/ {
#         alias /var/www/exam_management/backend/staticfiles/;
#         expires 30d;
#     }
# }
```

启用配置并重启Nginx:

```bash
sudo ln -s /etc/nginx/sites-available/exam_management /etc/nginx/sites-enabled/
sudo nginx -t  # 测试配置
sudo systemctl restart nginx
sudo systemctl enable nginx
```

### 第七步：配置防火墙

```bash
# Ubuntu (ufw)
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable

# CentOS (firewalld)
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

### 第八步：配置SSL证书（可选但推荐）

使用Let's Encrypt免费证书:

```bash
sudo apt install certbot python3-certbot-nginx  # Ubuntu
sudo yum install certbot python3-certbot-nginx  # CentOS

sudo certbot --nginx -d your-domain.com -d www.your-domain.com

# 自动续期
sudo certbot renew --dry-run
```

## 常用运维命令

### 查看服务状态

```bash
# Supervisor
sudo supervisorctl status exam_management
sudo supervisorctl restart exam_management
sudo supervisorctl stop exam_management
sudo supervisorctl start exam_management

# Nginx
sudo systemctl status nginx
sudo systemctl restart nginx

# 查看日志
tail -f /var/www/exam_management/backend/logs/gunicorn_error.log
tail -f /var/www/exam_management/backend/logs/gunicorn_access.log
tail -f /var/www/exam_management/backend/logs/supervisor.log
sudo tail -f /var/log/nginx/error.log
```

### 更新代码

```bash
cd /var/www/exam_management
git pull origin main

# 后端
cd backend
source venv/bin/activate
pip install -r requirements.txt
python manage.py migrate
python manage.py collectstatic --noinput
sudo supervisorctl restart exam_management

# 前端
cd ../frontend
npm install
npm run build
sudo systemctl reload nginx
```

## 安全建议

1. **修改SSH默认端口** (可选)
2. **禁用root SSH登录** (推荐)
3. **使用密钥认证** 而非密码
4. **定期更新系统和依赖**
5. **配置fail2ban** 防止暴力破解
6. **使用HTTPS** 加密传输
7. **定期备份数据库**

## 性能优化

1. **启用Nginx缓存** (对静态资源)
2. **使用CDN** (前端资源)
3. **配置Redis缓存** (Django缓存)
4. **数据库优化** (索引、查询优化)
5. **启用Gzip压缩**

## 故障排查

### 问题1: 502 Bad Gateway

- 检查Gunicorn是否运行: `sudo supervisorctl status`
- 检查端口占用: `netstat -tlnp | grep 8000`
- 查看日志: `tail -f /var/www/exam_management/backend/logs/gunicorn_error.log`

### 问题2: 静态文件404

- 确认collectstatic已运行
- 检查Nginx配置中的static路径
- 检查文件权限

### 问题3: 数据库连接失败

- 检查PostgreSQL服务: `sudo systemctl status postgresql`
- 检查.env配置
- 检查防火墙规则

## 后续支持

如有问题，请查看:
- Django日志: `/var/www/exam_management/backend/logs/`
- Nginx日志: `/var/log/nginx/`
- Supervisor日志: `/var/www/exam_management/backend/logs/supervisor.log`

